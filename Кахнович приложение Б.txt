&НаКлиенте
 Процедура ВыбратьПериод(Команда)
	 
	 ОписаниеОповещения = Новый ОписаниеОповещения("РезультатВыбораПериода",ЭтотОбъект);
	 ОткрытьФорму("ОбщаяФорма.ВыборСтандартногоПериода",,,,,,ОписаниеОповещения);
	 
 КонецПроцедуры
 &НаКлиенте
 Процедура Сформировать(Команда)
	 ТабличныйДокумент = СформироватьНаСервере();
 КонецПроцедуры
 
 &НаКлиенте
 Процедура РезультатВыбораПериода(Результат, ДополнительныеПараметры) Экспорт
	 Если Результат <> Неопределено Тогда 
		 ЭтотОбъект.Объект.НачалоПериода= Результат.НачалоПериода;
		 ЭтотОбъект.Объект.КонецПериода= Результат.КонецПериода;
	 КонецЕсли;
 КонецПроцедуры
 
 &НаСервере 
 Функция СформироватьНаСервере()
	 ДатаНачала = Объект.НачалоПериода;
	 ДатаОкончания = Объект.КонецПериода;
	 Подразделение = Объект.Подразделение;
	 ТабДок = Новый ТабличныйДокумент;
	 ТабДок.ФиксацияСлева = 1;
	 ТабДок.ФиксацияСверху = 4;
	 ЯчейкаНачалаДней = "R4C";
	 ЯчейкаНачалаСотрудников = "C1";
	 ЯчейкаНачалаНачислено = "C2";
	 СмещениеЯчеек = 3;
	 СмещениеЯчеекСотрудников = 5;
	 ТекОбъект = РеквизитФормыВЗначение("Объект");
	 Макет = ТекОбъект.ПолучитьМакет("Макет");
	 ОбластьШапка = Макет.ПолучитьОбласть("Шапка");
	 РазницаВДнях = (НачалоДня(ДатаОкончания) - НачалоДня(ДатаНачала)) / (60 * 60 * 24);
	 
	 СотрудникиСТалонами = ПолучитьСотрудников(ДатаНачала, ДатаОкончания, Подразделение);
	 МассивСотрудников = Новый Массив;
	 Счетчик = СмещениеЯчеекСотрудников;
	 Для Каждого СтрокаСотрудника Из СотрудникиСТалонами Цикл
		 МассивСотрудников.Добавить(СтрокаСотрудника.Сотрудник);
		 Ячейка = "R" + Строка(Счетчик) + ЯчейкаНачалаСотрудников;
		 ОбластьШапка.Область(Ячейка).Текст = СтрокаСотрудника.Сотрудник;
		 ОтобразитьГраницы(Ячейка,ОбластьШапка);
		 
		 Ячейка = "R" + Строка(Счетчик) + ЯчейкаНачалаНачислено;
		 ОбластьШапка.Область(Ячейка).Текст = СтрокаСотрудника.Сумма;
		 ОтобразитьГраницы(Ячейка,ОбластьШапка);
		 Счетчик = Счетчик + 1;
	 КонецЦикла;
	 
	 РасходТалонов = ПолучитьРасходТалонов(ДатаНачала, ДатаОкончания, МассивСотрудников);
	 РасходТалонов.Свернуть("Сотрудник, Дата","Сумма");
	 СмещениеСтолбца = 3;
	 МассивИтогов = Новый Массив;
	 Для Счетчик = СмещениеЯчеек По РазницаВДнях + СмещениеЯчеек Цикл
		 СмещениеСтроки = 5;
		 Ячейка = ЯчейкаНачалаДней + Строка(Счетчик);
		 ТекущийДень = ДобавитьДень(ДатаНачала,Счетчик-СмещениеЯчеек);
		 ОбластьШапка.Область(Ячейка).Текст = Формат(ТекущийДень,"ДЛФ=DD")+Символы.ПС+Формат(ТекущийДень,"ДФ=ддд");
		 ОтобразитьГраницы(Ячейка,ОбластьШапка);
		 Для Каждого Сотрудник Из МассивСотрудников Цикл
			 Отбор = Новый Структура("Сотрудник", Сотрудник);
			 Отбор.Вставить("Дата", ТекущийДень); 
			 РасходПоСотруднику = РасходТалонов.НайтиСтроки(Отбор);
			 Ячейка = "R" + Строка(СмещениеСтроки) + "C" + Строка(СмещениеСтолбца);
			 Если РасходПоСотруднику.Количество() <> 0 Тогда
				 ОбластьШапка.Область(Ячейка).Текст = РасходПоСотруднику[0].Сумма;
			 КонецЕсли;		
			 ОтобразитьГраницы(Ячейка,ОбластьШапка);
			 СмещениеСтроки = СмещениеСтроки+1;
		 КонецЦикла;
		 СмещениеСтолбца = СмещениеСтолбца + 1;
	 КонецЦикла;
	 
	 Ячейка = ЯчейкаНачалаДней + Строка(Счетчик);
	 ОбластьШапка.Область(Ячейка).Текст = "Итого";
	 ОтобразитьГраницы(Ячейка,ОбластьШапка);
	 СмещениеСтроки = 5;
	 
	 Для Каждого СтрокаСотрудника Из СотрудникиСТалонами Цикл
		 Отбор = Новый Структура("Сотрудник", СтрокаСотрудника.Сотрудник);
		 РасходПоСотруднику = РасходТалонов.НайтиСтроки(Отбор);
		 ИтоговаяСумма = 0;
		 Для Каждого Строка Из РасходПоСотруднику Цикл
			 ИтоговаяСумма = ИтоговаяСумма + Строка.Сумма;
		 КонецЦикла;
		 Ячейка = "R" + Строка(СмещениеСтроки) + "C" + Строка(Счетчик);
		 ОбластьШапка.Область(Ячейка).Текст = ИтоговаяСумма;
		 ОтобразитьГраницы(Ячейка,ОбластьШапка);
		 
		 Ячейка = "R" + Строка(СмещениеСтроки) + "C" + Строка(Счетчик+1);
		 ОбластьШапка.Область(Ячейка).Текст = СтрокаСотрудника.Сумма - ИтоговаяСумма;
		 ОтобразитьГраницы(Ячейка,ОбластьШапка);
		 
		 СмещениеСтроки = СмещениеСтроки+1;
	 КонецЦикла;
	 
	 Ячейка = ЯчейкаНачалаДней + Строка(Счетчик+1);
	 ОбластьШапка.Область(Ячейка).Текст = "Остаток";
	 ОтобразитьГраницы(Ячейка,ОбластьШапка);
	 
	 ОбластьШапка.Параметры.НачалоПериода = Формат(Объект.НачалоПериода,"ДФ=dd.MM.yyyy");
	 ОбластьШапка.Параметры.ОкончаниеПериода = Формат(Объект.КонецПериода,"ДФ=dd.MM.yyyy");
	 ТабДок.Вывести(ОбластьШапка);
	 
	 Возврат ТабДок;
 КонецФункции
 
 Функция ДобавитьДень(Дата, ЧислоДней)
	 Возврат Дата+86400*ЧислоДней;
 КонецФункции
 
 Функция ОтобразитьГраницы(Ячейка,Область)
	 Область.Область(Ячейка).ШиринаКолонки = 10;
	 Область.Область(Ячейка).РазмещениеТекста = ТипРазмещенияТекстаТабличногоДокумента.Переносить;
	 Область.Область(Ячейка).ВертикальноеПоложение = ВертикальноеПоложение.Верх;
	 Область.Область(Ячейка).ГраницаСверху = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная,1);
	 Область.Область(Ячейка).ГраницаСнизу = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная,1);
	 Область.Область(Ячейка).ГраницаСлева = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная,1);
	 Область.Область(Ячейка).ГраницаСправа = Новый Линия(ТипЛинииЯчейкиТабличногоДокумента.Сплошная,1); 
 КонецФункции
 
 Функция ПолучитьСотрудников(ДатаНачала, ДатаОкончания, Подразделение)
	 //{{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	 // Данный фрагмент построен конструктором.
	 // При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!
	 
	 Запрос = Новый Запрос;
	 Если ПустаяСтрока(Подразделение) Тогда
		 Запрос.Текст = 
		 "ВЫБРАТЬ
		 |	Сотрудники.Ссылка КАК Ссылка,
		 |	Сотрудники.Код КАК Код
		 |ПОМЕСТИТЬ ВременнаяТаблица
		 |ИЗ
		 |	Справочник.Сотрудники КАК Сотрудники
		 |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КадроваяИсторияСотрудниковИнтервальный КАК КадроваяИсторияСотрудниковИнтервальный
		 |		ПО (Сотрудники.Ссылка = КадроваяИсторияСотрудниковИнтервальный.Сотрудник)
		 |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ВидыЗанятостиСотрудников.СрезПоследних КАК ВидыЗанятостиСотрудниковСрезПоследних
		 |		ПО (ВидыЗанятостиСотрудниковСрезПоследних.Сотрудник = Сотрудники.Ссылка)
		 |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Пользователи КАК Пользователи
		 |		ПО (Сотрудники.ФизическоеЛицо = Пользователи.ФизическоеЛицо)
		 |ГДЕ
		 |	КадроваяИсторияСотрудниковИнтервальный.ВидСобытия <> ЗНАЧЕНИЕ(Перечисление.ВидыКадровыхСобытий.Увольнение)
		 |	И КадроваяИсторияСотрудниковИнтервальный.ДатаНачала <= КОНЕЦПЕРИОДА(&ДатаСреза, ДЕНЬ)
		 |	И КадроваяИсторияСотрудниковИнтервальный.ДатаОкончания >= КОНЕЦПЕРИОДА(&ДатаСреза, ДЕНЬ)
		 |	И ВидыЗанятостиСотрудниковСрезПоследних.ВидЗанятости <> ЗНАЧЕНИЕ(Перечисление.ВидыЗанятости.ВнутреннееСовместительство)
		 |
		 |СГРУППИРОВАТЬ ПО
		 |	Сотрудники.Ссылка,
		 |	Сотрудники.Код
		 |;
		 |
		 |////////////////////////////////////////////////////////////////////////////////
		 |ВЫБРАТЬ РАЗЛИЧНЫЕ
		 |	НачислениеТалоновНачисления.Сотрудник КАК Сотрудник,
		 |	НачислениеТалоновНачисления.Сумма КАК Сумма
		 |ИЗ
		 |	Документ.НачислениеТалонов.Начисления КАК НачислениеТалоновНачисления
		 |		ПРАВОЕ СОЕДИНЕНИЕ ВременнаяТаблица КАК ВременнаяТаблица
		 |		ПО (ВременнаяТаблица.Ссылка = НачислениеТалоновНачисления.Сотрудник)
		 |ГДЕ
		 |	НачислениеТалоновНачисления.Ссылка.Дата МЕЖДУ НАЧАЛОПЕРИОДА(&Начало, ДЕНЬ) И КОНЕЦПЕРИОДА(&Конец, ДЕНЬ)
		 |
		 |УПОРЯДОЧИТЬ ПО
		 |	Сотрудник
		 |АВТОУПОРЯДОЧИВАНИЕ";
		 
		 Запрос.УстановитьПараметр("Начало", ДатаНачала);
		 Запрос.УстановитьПараметр("Конец", ДатаОкончания);
		 Запрос.УстановитьПараметр("ДатаСреза",ДатаОкончания);
	 Иначе
		 Запрос.Текст = 
		 "ВЫБРАТЬ
		 |	Сотрудники.Ссылка КАК Ссылка,
		 |	Сотрудники.Код КАК Код
		 |ПОМЕСТИТЬ ВременнаяТаблица
		 |ИЗ
		 |	Справочник.Сотрудники КАК Сотрудники
		 |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КадроваяИсторияСотрудниковИнтервальный КАК КадроваяИсторияСотрудниковИнтервальный
		 |		ПО (Сотрудники.Ссылка = КадроваяИсторияСотрудниковИнтервальный.Сотрудник)
		 |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ВидыЗанятостиСотрудников.СрезПоследних КАК ВидыЗанятостиСотрудниковСрезПоследних
		 |		ПО (ВидыЗанятостиСотрудниковСрезПоследних.Сотрудник = Сотрудники.Ссылка)
		 |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Пользователи КАК Пользователи
		 |		ПО (Сотрудники.ФизическоеЛицо = Пользователи.ФизическоеЛицо)
		 |ГДЕ
		 |	КадроваяИсторияСотрудниковИнтервальный.ВидСобытия <> ЗНАЧЕНИЕ(Перечисление.ВидыКадровыхСобытий.Увольнение)
		 |	И КадроваяИсторияСотрудниковИнтервальный.ДатаНачала <= КОНЕЦПЕРИОДА(&ДатаСреза, ДЕНЬ)
		 |	И КадроваяИсторияСотрудниковИнтервальный.ДатаОкончания >= КОНЕЦПЕРИОДА(&ДатаСреза, ДЕНЬ)
		 |	И ВидыЗанятостиСотрудниковСрезПоследних.ВидЗанятости <> ЗНАЧЕНИЕ(Перечисление.ВидыЗанятости.ВнутреннееСовместительство)
		 |	И КадроваяИсторияСотрудниковИнтервальный.Подразделение = &Подразделение
		 |
		 |СГРУППИРОВАТЬ ПО
		 |	Сотрудники.Ссылка,
		 |	Сотрудники.Код
		 |;
		 |
		 |////////////////////////////////////////////////////////////////////////////////
		 |ВЫБРАТЬ РАЗЛИЧНЫЕ
		 |	НачислениеТалоновНачисления.Сотрудник КАК Сотрудник,
		 |	НачислениеТалоновНачисления.Сумма КАК Сумма
		 |ИЗ
		 |	Документ.НачислениеТалонов.Начисления КАК НачислениеТалоновНачисления
		 |		ПРАВОЕ СОЕДИНЕНИЕ ВременнаяТаблица КАК ВременнаяТаблица
		 |		ПО (ВременнаяТаблица.Ссылка = НачислениеТалоновНачисления.Сотрудник)
		 |ГДЕ
		 |	НачислениеТалоновНачисления.Ссылка.Дата МЕЖДУ НАЧАЛОПЕРИОДА(&Начало, ДЕНЬ) И КОНЕЦПЕРИОДА(&Конец, ДЕНЬ)
		 |
		 |УПОРЯДОЧИТЬ ПО
		 |	Сотрудник
		 |АВТОУПОРЯДОЧИВАНИЕ";
		 
		 Запрос.УстановитьПараметр("Начало", ДатаНачала);
		 Запрос.УстановитьПараметр("Конец", ДатаОкончания);
		 Запрос.УстановитьПараметр("ДатаСреза",ДатаОкончания);
		 Запрос.УстановитьПараметр("Подразделение", Подразделение);
	 КонецЕсли;
	 
	 РезультатЗапроса = Запрос.Выполнить();
	 
	 Результат = РезультатЗапроса.Выгрузить();
	 
	 Возврат Результат;
	 
	 //}}КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	 
 КонецФункции
 
 Функция ПолучитьРасходТалонов(ДатаНачала,ДатаОкончания,Сотрудники)
	 //{{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	 // Данный фрагмент построен конструктором.
	 // При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!
	 
	 Запрос = Новый Запрос;
	 Запрос.Текст = 
	 "ВЫБРАТЬ
	 |	ПродажиПоТалонам.Сотрудник КАК Сотрудник,
	 |	ПродажиПоТалонам.Сумма КАК Сумма,
	 |	НАЧАЛОПЕРИОДА(ПродажиПоТалонам.Дата, ДЕНЬ) КАК Дата
	 |ИЗ
	 |	Документ.ПродажиПоТалонам КАК ПродажиПоТалонам
	 |ГДЕ
	 |	ПродажиПоТалонам.Дата МЕЖДУ &Начало И &Конец
	 |	И ПродажиПоТалонам.Сотрудник В(&Сотрудники)";
	 
	 Запрос.УстановитьПараметр("Начало", ДатаНачала);
	 Запрос.УстановитьПараметр("Конец", КонецДня(ДатаОкончания));
	 Запрос.УстановитьПараметр("Сотрудники", Сотрудники);
	 
	 РезультатЗапроса = Запрос.Выполнить();
	 
	 Результат = РезультатЗапроса.Выгрузить();	
	 
	 Возврат Результат;
	 //}}КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	 
 КонецФункции
